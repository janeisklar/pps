#!/usr/bin/env python

import os, string, sys, time, commands, re

dir_base = "/sacher/raid/fmri/ssh11/subjects/"
dir_working = os.getcwd()
dir_script = sys.path[0]

merge_command = 'export FSLOUTPUTTYPE=NIFTI_GZ; /usr/local/fsl/bin/fslmerge -t '
actions = [];

lastaction = ''
lastaction_i = 0


if len( sys.argv ) <= 1:
	print'###################################################################################################'
	print '[' + time.strftime("%H:%M:%S") + '] Importing DICOMs from ' + dir_working
	print'###################################################################################################'

	filelist = os.listdir( dir_working )
	for filename in filelist:
		chunks = string.split( filename, '.' )
		subject = string.split( chunks[0], '_' )[0]
		measurement = string.split( chunks[0], '_' )[1]
		run = chunks[3]
	
		dir_subject = string.lower( dir_base + subject )
		dir_measurement = string.lower( dir_subject + '/' + measurement )
		dir_run = string.lower( dir_measurement + '/scan_' + run ) 
	

		if not os.path.exists( dir_subject ):
			os.mkdir( dir_subject, 0775 )
		if not os.path.exists( dir_measurement ):
			os.mkdir( dir_measurement, 0775 )
		if not os.path.exists( dir_run ):
			os.mkdir( dir_run, 0775 )
			os.mkdir( dir_run + '/dicom', 0775 )
			os.mkdir( dir_run + '/nifti', 0775 )
	
		os.system( 'mv ' + filename + ' ' + dir_run + '/dicom' )
	
		if len( actions ) == 0:
			actions.append( dir_run )
	
		if actions[-1] != dir_run:
			print  '%4d File(s) -> %s/dicom' % (lastaction_i, actions[-1])
			lastaction_i = 0
			actions.append( dir_run )

		lastaction_i += 1

		if filename == filelist[-1]:
			print  '%4d File(s) -> %s/dicom' % (lastaction_i, actions[-1])

	print '[' + time.strftime("%H:%M:%S") + '] Done.'
else:
	actions = sys.argv[1:];



for d in actions:
	if not os.path.exists( d + '/dicom/dicom.tar.gz' ):
		print'###################################################################################################'
		print '[' + time.strftime("%H:%M:%S") + '] Converting DICOMs to NIFTIs in ' + d
		print'###################################################################################################'
		run_name = string.lower( string.split( commands.getoutput(dir_script + '/dicomhead ' + d +  '/dicom/*.1.*.IMA | grep "ID Series Description"'), '//' )[2] )
		run_id = string.split( d, '/' )[-1]

		os.system( dir_script + '/convert_dicom.sh ' + d )

		#print commands.getoutput('./dicomhead ' + d +  '/dicom/*.1.*.IMA | grep "ID Series Description"')
		
#		os.system( 'cd ln -s ' + d + ' ' + re.sub( 'run_.?/', '', d ) + run_id )
#		os.system( 'cd %s; ln -s run_%d' + d + ' ' + re.sub( 'run_.?/', '', d ) + run_id )
				
		create_link = True
		
		if os.path.exists( d + '/../' + run_name ):
			if string.split( commands.getoutput('ls -l %s/../%s ' % (d, run_name)), '-> ' )[-1] == run_id:
				create_link = False
			else:
				print 'WARNING: Run exisits. Moving old run to %s_before_%s' % (run_name, run_id )
				os.system( 'cd %s/..; mv %s %s_before_%s;' % (d, run_name, run_name, run_id ) )
		
		if create_link:
			os.system( 'cd %s/..; ln -s %s %s;' % (d, run_id, run_name ) )


	print'###################################################################################################'
	print '[' + time.strftime("%H:%M:%S") + '] Preprocessing ' + d
	print'###################################################################################################'		
	
	os.system( '/usr/local/matlab74/bin/matlab -nodesktop -nosplash -r "cd ' + dir_script + '; swa( \'' + d + '/nifti\' );exit;"' )

	print '[' + time.strftime("%H:%M:%S") + '] Done.'


	
	print'###################################################################################################'
	print '[' + time.strftime("%H:%M:%S") + '] Cleaning up NIFTIs in ' + d
	print'###################################################################################################'

	
	
	if os.path.exists( d + '/nifti/vols.nii' ) and os.path.exists( d + '/nifti/swavol0000.nii' ):
		if os.path.getsize( d + '/nifti/vols.nii' ) > 0:
			os.system( 'rm -f ' + d + '/nifti/vol????.nii;' )

	os.system( merge_command + d + '/nifti/avols.nii ' + d + '/nifti/avol*.nii' )
	if os.path.exists( d + '/nifti/avols.nii.gz' ) and os.path.exists( d + '/nifti/swavol0000.nii' ):
		if os.path.getsize( d + '/nifti/avols.nii.gz' ) > 0:
			os.system( 'rm -f ' + d + '/nifti/avol????.nii;' )

	os.system( merge_command + d + '/nifti/wavols.nii ' + d + '/nifti/wavol*.nii' )
	if os.path.exists( d + '/nifti/wavols.nii.gz' ) and os.path.exists( d + '/nifti/swavol0000.nii' ):
		if os.path.getsize( d + '/nifti/wavols.nii.gz' ) > 0:
			os.system( 'rm -f ' + d + '/nifti/wavol????.nii;' );

	os.system( merge_command + d + '/nifti/swavols.nii ' + d + '/nifti/swavol*.nii' )
	print '[' + time.strftime("%H:%M:%S") + '] Done.'
	
